name: CD - Update Service Images

on:
  repository_dispatch:
    types:
      - update-agent-image
      - update-mcp-image
      - update-model-image
      - update-user-image

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: Update image in manifest
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          NEW_IMAGE="${{ github.event.client_payload.image }}"
          SHA="${{ github.event.client_payload.sha }}"
          REF="${{ github.event.client_payload.ref }}"
          ACTOR="${{ github.event.client_payload.actor }}"

          echo "ðŸ”„ Updating $SERVICE to image: $NEW_IMAGE"

          # ç¡®å®šçŽ¯å¢ƒ (dev, staging, production)
          ENVIRONMENT="dev"
          if [[ "$REF" == "main" ]]; then
            ENVIRONMENT="staging"
          elif [[ "$REF" == "production" || "$REF" == refs/tags/* ]]; then
            ENVIRONMENT="production"
          fi

          # æ›´æ–° base deployment
          BASE_MANIFEST="deployments/kubernetes/base/applications/${SERVICE}-deployment.yaml"

          if [ -f "$BASE_MANIFEST" ]; then
            echo "ðŸ“ Updating $BASE_MANIFEST"
            yq eval ".spec.template.spec.containers[0].image = \"${NEW_IMAGE}\"" -i "$BASE_MANIFEST"
            echo "âœ… Updated base manifest"
          else
            echo "âš ï¸ Warning: $BASE_MANIFEST not found"
          fi

          # æ›´æ–° overlay kustomization (å¦‚æžœå­˜åœ¨)
          OVERLAY_KUSTOMIZATION="deployments/kubernetes/overlays/${ENVIRONMENT}/kustomization.yaml"

          if [ -f "$OVERLAY_KUSTOMIZATION" ]; then
            echo "ðŸ“ Updating $OVERLAY_KUSTOMIZATION"

            # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥æœåŠ¡çš„é•œåƒé…ç½®
            if yq eval ".images[] | select(.name == \"${SERVICE}\")" "$OVERLAY_KUSTOMIZATION" | grep -q .; then
              # æ›´æ–°çŽ°æœ‰é•œåƒ
              yq eval "(.images[] | select(.name == \"${SERVICE}\") | .newName) = \"${NEW_IMAGE%:*}\"" -i "$OVERLAY_KUSTOMIZATION"
              yq eval "(.images[] | select(.name == \"${SERVICE}\") | .newTag) = \"${NEW_IMAGE##*:}\"" -i "$OVERLAY_KUSTOMIZATION"
            else
              # æ·»åŠ æ–°é•œåƒé…ç½®
              yq eval ".images += [{\"name\": \"${SERVICE}\", \"newName\": \"${NEW_IMAGE%:*}\", \"newTag\": \"${NEW_IMAGE##*:}\"}]" -i "$OVERLAY_KUSTOMIZATION"
            fi

            echo "âœ… Updated overlay kustomization"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          SERVICE="${{ github.event.client_payload.service }}"
          SHA="${{ github.event.client_payload.sha }}"
          ACTOR="${{ github.event.client_payload.actor }}"

          git add deployments/kubernetes/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi

          git commit -m "chore(gitops): update ${SERVICE} image to ${SHA}

Triggered by: ${ACTOR}
Source commit: ${SHA}
Service: ${SERVICE}

          git push

          echo "âœ… Changes pushed to repository"

      - name: Create deployment summary
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          IMAGE="${{ github.event.client_payload.image }}"
          SHA="${{ github.event.client_payload.sha }}"

          echo "### ðŸš€ Service Image Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | \`${SERVICE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${IMAGE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${SHA}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ArgoCD will automatically sync this change to EKS" >> $GITHUB_STEP_SUMMARY
