kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: isa-cloud-local

# 节点配置
nodes:
  # 控制平面节点
  - role: control-plane
    kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "ingress-ready=true"
    # 端口映射 - 将容器端口映射到主机
    extraPortMappings:
    # HTTP/HTTPS
    - containerPort: 80
      hostPort: 80
      protocol: TCP
    - containerPort: 443
      hostPort: 443
      protocol: TCP
    # 基础设施服务
    - containerPort: 8500      # Consul UI
      hostPort: 8500
      protocol: TCP
    - containerPort: 8600      # Consul DNS
      hostPort: 8600
      protocol: TCP
    - containerPort: 6379      # Redis
      hostPort: 6379
      protocol: TCP
    - containerPort: 9000      # MinIO API
      hostPort: 9000
      protocol: TCP
    - containerPort: 9001      # MinIO Console
      hostPort: 9001
      protocol: TCP
    - containerPort: 4222      # NATS
      hostPort: 4222
      protocol: TCP
    - containerPort: 4223      # NATS Monitoring
      hostPort: 4223
      protocol: TCP
    - containerPort: 1883      # MQTT
      hostPort: 1883
      protocol: TCP
    - containerPort: 3100      # Loki
      hostPort: 3100
      protocol: TCP
    - containerPort: 3000      # Grafana
      hostPort: 3000
      protocol: TCP
    # Database Services
    - containerPort: 5432      # PostgreSQL
      hostPort: 5432
      protocol: TCP
    - containerPort: 7474      # Neo4j HTTP
      hostPort: 7474
      protocol: TCP
    - containerPort: 7687      # Neo4j Bolt
      hostPort: 7687
      protocol: TCP
    - containerPort: 6333      # Qdrant HTTP
      hostPort: 6333
      protocol: TCP
    - containerPort: 6334      # Qdrant gRPC (native)
      hostPort: 6334
      protocol: TCP
    # APISIX API Gateway
    - containerPort: 9080      # APISIX HTTP
      hostPort: 9080
      protocol: TCP
    - containerPort: 9180      # APISIX Admin API
      hostPort: 9180
      protocol: TCP
    - containerPort: 9443      # APISIX HTTPS
      hostPort: 9443
      protocol: TCP
    - containerPort: 9010      # APISIX Dashboard
      hostPort: 9010
      protocol: TCP
    - containerPort: 2379      # etcd (APISIX storage)
      hostPort: 2379
      protocol: TCP
    # ML Platform
    - containerPort: 8265      # Ray Dashboard
      hostPort: 8265
      protocol: TCP
    - containerPort: 5000      # MLflow
      hostPort: 5000
      protocol: TCP
    - containerPort: 8888      # JupyterHub
      hostPort: 8888
      protocol: TCP

  # 工作节点（可根据资源调整数量）
  - role: worker
  - role: worker

# 网络配置
networking:
  disableDefaultCNI: false
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"

# Containerd 配置 - 支持本地镜像仓库
containerdConfigPatches:
- |-
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5001"]
    endpoint = ["http://localhost:5001"]
