apiVersion: apps/v1
kind: Deployment
metadata:
  name: neo4j-grpc
  namespace: isa-cloud-staging
  labels:
    app: neo4j-grpc
    tier: grpc-services
spec:
  replicas: 2
  selector:
    matchLabels:
      app: neo4j-grpc
  template:
    metadata:
      labels:
        app: neo4j-grpc
        tier: grpc-services
    spec:
      containers:
        - name: neo4j-grpc
          image: isa-neo4j-service:latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: grpc
              containerPort: 50063
              protocol: TCP

          env:
            - name: SERVICE_HOSTNAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            # Neo4j Connection
            - name: NEO4J_URI
              value: "bolt://neo4j.isa-cloud-staging.svc.cluster.local:7687"
            - name: NEO4J_USERNAME
              value: "neo4j"
            - name: NEO4J_PASSWORD
              value: "staging_neo4j_2024"
            - name: NEO4J_DATABASE
              value: "neo4j"
            - name: NEO4J_MAX_CONNECTION_POOL_SIZE
              value: "50"
            # Consul
            - name: CONSUL_ENABLED
              value: "true"
            - name: CONSUL_HOST
              value: "consul.isa-cloud-staging.svc.cluster.local"
            - name: CONSUL_PORT
              value: "8500"
            # gRPC Configuration
            - name: GRPC_PORT
              value: "50063"
            - name: SERVICE_NAME
              value: "neo4j-grpc-service"

          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 256m
              memory: 512Mi

          livenessProbe:
            tcpSocket:
              port: 50063
            initialDelaySeconds: 30
            periodSeconds: 10

          readinessProbe:
            tcpSocket:
              port: 50063
            initialDelaySeconds: 10
            periodSeconds: 5

      initContainers:
        - name: wait-for-neo4j
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            [
              "sh",
              "-c",
              "until nc -z neo4j.isa-cloud-staging.svc.cluster.local 7687; do echo waiting for neo4j; sleep 2; done",
            ]
