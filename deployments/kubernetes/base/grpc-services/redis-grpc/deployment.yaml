apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-grpc
  namespace: isa-cloud-staging
  labels:
    app: redis-grpc
    tier: grpc-services
spec:
  replicas: 2
  selector:
    matchLabels:
      app: redis-grpc
  template:
    metadata:
      labels:
        app: redis-grpc
        tier: grpc-services
    spec:
      containers:
      - name: redis-grpc
        image: redis-service:staging
        imagePullPolicy: IfNotPresent  # For kind: use local images if available
        ports:
        - name: grpc
          containerPort: 50055
          protocol: TCP

        env:
        - name: GRPC_PORT
          value: "50055"
        - name: REDIS_HOST
          value: "redis.isa-cloud-staging.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: CONSUL_HTTP_ADDR
          value: "consul-ui.isa-cloud-staging.svc.cluster.local:8500"
        - name: SERVICE_NAME
          value: "redis-grpc"
        - name: LOG_LEVEL
          value: "info"

        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 256m
            memory: 512Mi

        livenessProbe:
          exec:
            command:
            - grpc_health_probe
            - -addr=:50055
          initialDelaySeconds: 30
          periodSeconds: 10

        readinessProbe:
          exec:
            command:
            - grpc_health_probe
            - -addr=:50055
          initialDelaySeconds: 5
          periodSeconds: 5

      # Optional: Add init container to wait for Redis
      initContainers:
      - name: wait-for-redis
        image: busybox:1.36
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          until nc -z redis.isa-cloud-staging.svc.cluster.local 6379; do
            echo "Waiting for Redis..."
            sleep 2
          done
