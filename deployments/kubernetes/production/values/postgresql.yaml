# PostgreSQL Helm Values - PRODUCTION (HA + High Performance)
# Chart: bitnami/postgresql
# Install: helm install postgresql bitnami/postgresql -n isa-cloud-production -f helm-values/production/postgresql.yaml

# HA architecture with read replicas
architecture: replication

# Authentication (use external secrets in real production)
auth:
  postgresPassword: ""  # Set via --set or external secret
  database: "isa_platform"
  existingSecret: "postgresql-secret"  # Use K8s secret

# =============================================================================
# PRIMARY NODE (Writes)
# =============================================================================
primary:
  # High-performance resources
  resources:
    requests:
      cpu: 2000m
      memory: 4Gi
    limits:
      cpu: 4000m
      memory: 8Gi

  # Production storage (use fast SSD storage class)
  persistence:
    enabled: true
    size: 100Gi
    storageClass: "fast-ssd"  # Adjust to your cloud provider

  # High-performance PostgreSQL configuration
  configuration: |
    # Connection Settings
    max_connections = 500
    superuser_reserved_connections = 5

    # Memory Settings (tune based on available RAM)
    shared_buffers = 2GB
    effective_cache_size = 6GB
    work_mem = 64MB
    maintenance_work_mem = 512MB

    # WAL Settings (for durability + performance)
    wal_buffers = 64MB
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_size = 1GB

    # Checkpoint Settings
    checkpoint_completion_target = 0.9
    checkpoint_timeout = 15min
    max_wal_size = 4GB
    min_wal_size = 1GB

    # Query Planner
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100

    # Parallel Query
    max_parallel_workers_per_gather = 4
    max_parallel_workers = 8
    max_parallel_maintenance_workers = 4

    # Logging (for debugging, reduce in production if needed)
    log_min_duration_statement = 1000
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on

    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 4
    autovacuum_naptime = 30s
    autovacuum_vacuum_cost_limit = 1000

  # Init scripts
  initdb:
    scripts:
      00-extensions.sql: |
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
        CREATE EXTENSION IF NOT EXISTS "pg_trgm";
        CREATE EXTENSION IF NOT EXISTS "btree_gin";
        CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

  # Pod configuration
  podLabels:
    tier: infrastructure
    environment: production

  # Anti-affinity: spread across nodes
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/component: primary
          topologyKey: kubernetes.io/hostname

  # Pod Disruption Budget
  pdb:
    create: true
    minAvailable: 1

# =============================================================================
# READ REPLICAS (Reads - Scale Out)
# =============================================================================
readReplicas:
  replicaCount: 2

  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi

  persistence:
    enabled: true
    size: 100Gi
    storageClass: "fast-ssd"

  # Anti-affinity: spread across nodes
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/component: read
          topologyKey: kubernetes.io/hostname

  # Pod Disruption Budget
  pdb:
    create: true
    minAvailable: 1

# =============================================================================
# SERVICE
# =============================================================================
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# =============================================================================
# METRICS & MONITORING
# =============================================================================
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
  resources:
    requests:
      cpu: 100m
      memory: 128Mi

# =============================================================================
# BACKUP (using volumeSnapshots or external backup tool)
# =============================================================================
backup:
  enabled: false  # Use Velero or cloud-native backup instead

# =============================================================================
# PGPOOL (Connection Pooling + Load Balancing) - Optional
# =============================================================================
# For even higher performance, consider deploying PgBouncer separately
# or use bitnami/postgresql-ha chart which includes Pgpool
