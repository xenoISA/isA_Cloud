# PostgreSQL HA - Bitnami Chart Values
# Chart: bitnami/postgresql-ha
# Docs: https://github.com/bitnami/charts/tree/main/bitnami/postgresql-ha

global:
  storageClass: "infotrend-block"
  postgresql:
    auth:
      postgresPassword: ""        # Set via --set or external secret
      replicationPassword: ""     # Set via --set or external secret
      database: "isa_production"
      username: "isa_admin"
      password: ""                # Set via --set or external secret

# PostgreSQL configuration
postgresql:
  replicaCount: 3                 # 1 primary + 2 standby

  # Pod resources
  resources:
    requests:
      cpu: "1000m"
      memory: "2Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"

  # Persistence
  persistence:
    enabled: true
    storageClass: "infotrend-block"
    size: 100Gi
    accessModes:
      - ReadWriteOnce

  # Extended configuration
  extendedConfiguration: |
    max_connections = 500
    shared_buffers = 1GB
    effective_cache_size = 3GB
    maintenance_work_mem = 256MB
    checkpoint_completion_target = 0.9
    wal_buffers = 64MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 4MB
    min_wal_size = 1GB
    max_wal_size = 4GB
    max_worker_processes = 4
    max_parallel_workers_per_gather = 2
    max_parallel_workers = 4
    max_parallel_maintenance_workers = 2
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    hot_standby = on

  # Pod anti-affinity (spread across nodes)
  podAntiAffinityPreset: hard

  # Node affinity (optional - uncomment to pin to specific nodes)
  # nodeSelector:
  #   node-role.kubernetes.io/database: "true"

  # Tolerations (optional)
  # tolerations:
  #   - key: "dedicated"
  #     operator: "Equal"
  #     value: "database"
  #     effect: "NoSchedule"

  # Liveness/Readiness probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  readinessProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

# Pgpool configuration (connection pooling + load balancing)
pgpool:
  replicaCount: 2

  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  # Pgpool configuration
  configuration: |
    num_init_children = 100
    max_pool = 4
    child_life_time = 300
    child_max_connections = 0
    connection_life_time = 0
    client_idle_limit = 0
    load_balance_mode = on
    master_slave_mode = on
    master_slave_sub_mode = 'stream'
    sr_check_period = 10
    health_check_period = 10
    health_check_timeout = 20
    health_check_max_retries = 3
    failover_on_backend_error = on

  podAntiAffinityPreset: soft

# Service configuration
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# Metrics (Prometheus)
metrics:
  enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "100m"
      memory: "128Mi"
  serviceMonitor:
    enabled: true
    namespace: isa-cloud-production
    labels:
      release: prometheus

# Backup configuration (optional - enable if using volumeSnapshots)
# backup:
#   enabled: true
#   cronjob:
#     schedule: "0 2 * * *"  # Daily at 2 AM
#     storage:
#       storageClass: "infotrend-nfs"
#       size: 100Gi

# Pod Disruption Budget
pdb:
  create: true
  minAvailable: 2
  maxUnavailable: 1

# Network Policy
networkPolicy:
  enabled: true
  allowExternal: false
  ingressNSMatchLabels:
    kubernetes.io/metadata.name: isa-cloud-production
