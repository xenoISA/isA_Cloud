# ============================================
# isA Platform - Staging Environment (AWS)
# ============================================
# Uses ECR images for all services
# Infrastructure managed by AWS (RDS, ElastiCache, etc.)
# Use: docker-compose -f docker-compose.staging.yml up -d

include:
  - compose/base.yml
  - compose/infrastructure.yml
  - compose/observability.yml
  - compose/services.yml

# ============================================
# Staging Overrides
# ============================================

services:
  # Infrastructure - Use AWS-managed or simplified setup
  consul:
    image: ${ECR_REGISTRY}/isa-consul:${IMAGE_TAG:-latest}
    restart: unless-stopped

  nats-1:
    image: ${ECR_REGISTRY}/isa-nats:${IMAGE_TAG:-latest}
    restart: unless-stopped

  nats-2:
    image: ${ECR_REGISTRY}/isa-nats:${IMAGE_TAG:-latest}
    restart: unless-stopped

  nats-3:
    image: ${ECR_REGISTRY}/isa-nats:${IMAGE_TAG:-latest}
    restart: unless-stopped

  gateway:
    image: ${ECR_REGISTRY}/isa-gateway:${IMAGE_TAG:-latest}
    build: null  # Don't build, use ECR image
    ports:
      - "80:8000"  # Standard HTTP port for ALB
    environment:
      - ENVIRONMENT=staging
      - CONSUL_HOST=consul.staging.isa.local
      - CONSUL_PORT=8500
      - NATS_URL=${NATS_URL:-nats://nats-1.staging.isa.local:4222,nats://nats-2.staging.isa.local:4222,nats://nats-3.staging.isa.local:4222}
      - LOKI_URL=${LOKI_URL:-http://loki.staging.isa.local:3100}
      - LOKI_ENABLED=${LOKI_ENABLED:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: unless-stopped

  # Observability
  loki:
    restart: unless-stopped

  promtail:
    restart: unless-stopped

  grafana:
    ports:
      - "3003:3000"
    environment:
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-https://grafana-staging.isa-platform.com}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}  # Must be set in .env
    restart: unless-stopped

  # AI Services
  mcp:
    image: ${ECR_REGISTRY}/isa-mcp:${IMAGE_TAG:-latest}
    build: null  # Don't build, use ECR image
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${MCP_DATABASE_URL}  # AWS RDS
      - REDIS_URL=${REDIS_URL}  # AWS ElastiCache
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - LOG_LEVEL=INFO
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  model:
    image: ${ECR_REGISTRY}/isa-model:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${MODEL_DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - LOG_LEVEL=INFO
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN}
      - HF_TOKEN=${HF_TOKEN}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G

  agent:
    image: ${ECR_REGISTRY}/isa-agent:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${AGENT_DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - LOG_LEVEL=INFO
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # User Services
  account-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
    restart: unless-stopped

  auth-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
    restart: unless-stopped

  authorization-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
    restart: unless-stopped

  payment-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    restart: unless-stopped

  device-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
      - MQTT_URL=${MQTT_URL}
    restart: unless-stopped

  event-service:
    image: ${ECR_REGISTRY}/isa-user:${IMAGE_TAG:-latest}
    build: null
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - NATS_URL=${NATS_URL}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
      - LOKI_ENABLED=true
    restart: unless-stopped
