# ISA Model Service - Production Docker Image
#
# This Dockerfile creates a lightweight production image for the ISA Model service
# using cloud-based inference (OpenAI, Replicate) for minimal image size.
#
# Build:
#   docker build -f Dockerfile.model -t isa-model:latest .
#
# Run:
#   docker run -p 8000:8000 --env-file .env isa-model:latest
#
# Multi-arch build:
#   docker buildx build --platform linux/amd64,linux/arm64 -f Dockerfile.model -t isa-model:latest .

# Stage 1: Builder
FROM python:3.11-slim AS builder

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install uv for fast package installation
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

# Set working directory
WORKDIR /build

# Copy project files
COPY pyproject.toml README.md ./
COPY isa_model/ ./isa_model/

# Create virtual environment and install dependencies
# Using 'cloud' extras for minimal production image (OpenAI + Replicate only)
RUN uv venv /opt/venv && \
    . /opt/venv/bin/activate && \
    uv pip install --no-cache-dir -e ".[cloud]"

# Stage 2: Runtime
FROM python:3.11-slim

# Install runtime system dependencies only
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -m -u 1000 isamodel && \
    mkdir -p /app /app/logs /app/cache && \
    chown -R isamodel:isamodel /app

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv

# Copy application code
WORKDIR /app
COPY --chown=isamodel:isamodel main.py ./
COPY --chown=isamodel:isamodel isa_model/ ./isa_model/
COPY --chown=isamodel:isamodel deployment/ ./deployment/

# Set environment variables
ENV PATH="/opt/venv/bin:${PATH}" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app \
    ISA_ENV=production \
    HOST=0.0.0.0 \
    WORKERS=1 \
    LOG_LEVEL=info \
    CACHE_DIR=/app/cache \
    LOG_DIR=/app/logs

# Switch to non-root user
USER isamodel

# Expose port (default 8082, can be overridden)
EXPOSE 8082

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8082/health || exit 1

# Run the application
CMD ["python", "main.py"]
