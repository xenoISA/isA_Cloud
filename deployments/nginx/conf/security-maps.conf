# Security Map and Geo Directives
# These MUST be in the http context only
# File: deployments/nginx/conf/security-maps.conf

# Security Headers
map $sent_http_content_type $csp_header {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:;";
    ~*text/html "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' wss: https:; frame-ancestors 'none';";
}

# GeoIP blocking (requires ngx_http_geoip_module or GeoIP2)
# Uncomment and configure if you have GeoIP database
# map $geoip_country_code $allowed_country {
#     default no;
#     US yes;
#     CA yes;
#     GB yes;
#     # Add your allowed countries
# }

# IP Blacklist/Whitelist
# Define blocked IPs
geo $blocked_ip {
    default 0;
    # Add malicious IPs here
    # 1.2.3.4 1;
    # 5.6.7.8 1;
}

# Define whitelisted IPs (bypass rate limiting)
geo $whitelisted_ip {
    default 0;
    # Add trusted IPs here (e.g., monitoring services, CI/CD)
    # 10.0.0.0/8 1;
    # 172.16.0.0/12 1;
    # 192.168.0.0/16 1;
}

# User-Agent blocking (bots, scanners)
map $http_user_agent $blocked_agent {
    default 0;
    "~*masscan" 1;
    "~*nmap" 1;
    "~*sqlmap" 1;
    "~*nikto" 1;
    "~*havij" 1;
    "~*acunetix" 1;
    "~*ZmEu" 1;
    "~*bot" 0;  # Allow legitimate bots
    "~*spider" 0;
    "~*crawler" 0;
}

# Request method whitelist
map $request_method $allowed_method {
    default 0;
    GET 1;
    POST 1;
    PUT 1;
    DELETE 1;
    PATCH 1;
    HEAD 1;
    OPTIONS 1;
}

# Common attack pattern detection
# SQL Injection patterns
map $args $sql_injection {
    default 0;
    "~*union.*select" 1;
    "~*concat.*\(" 1;
    "~*declare.*\@" 1;
}

map $request_uri $sql_injection_uri {
    default 0;
    "~*union.*select" 1;
    "~*concat.*\(" 1;
}

# XSS patterns
map $args $xss_attack {
    default 0;
    "~*<script" 1;
    "~*javascript:" 1;
    "~*onerror=" 1;
    "~*onload=" 1;
}

# Path traversal
map $request_uri $path_traversal {
    default 0;
    "~*\.\." 1;
    "~*/etc/passwd" 1;
    "~*/proc/self" 1;
}

# File inclusion
map $args $file_injection {
    default 0;
    "~*\.\./\.\." 1;
    "~*php://input" 1;
    "~*file://" 1;
}

# Combined attack detection
geo $attack_detected {
    default 0;
}

# Set attack flag if any pattern matches
map "$sql_injection$sql_injection_uri$xss_attack$path_traversal$file_injection" $combined_attack {
    default 0;
    "~*1" 1;
}
