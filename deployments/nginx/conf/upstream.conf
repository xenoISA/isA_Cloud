# Upstream configuration for isA_Cloud Gateway
# Defines backend Go gateway instances

# Main Go Gateway (Application Layer)
upstream isa_gateway {
    least_conn;  # Load balancing algorithm

    # Primary gateway instance
    server gateway:8000 max_fails=3 fail_timeout=30s weight=1;

    # Add more gateway instances for horizontal scaling
    # server gateway-2:8000 max_fails=3 fail_timeout=30s weight=1;
    # server gateway-3:8000 max_fails=3 fail_timeout=30s weight=1;

    # Connection pooling
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Consul service (for health checks and service discovery)
upstream consul {
    server consul:8500 max_fails=2 fail_timeout=10s;
    keepalive 8;
}

# Grafana monitoring (optional)
upstream grafana {
    server grafana:3000 max_fails=2 fail_timeout=10s;
    keepalive 8;
}

# Define health check settings
# This requires nginx plus or custom module, for open source we use passive health checks
# For active health checks with OpenResty, we can use lua-resty-upstream-healthcheck

# Sticky session support (if needed for stateful connections)
# This is useful for WebSocket or SSE connections
# hash $remote_addr consistent;

# Backup server (optional)
# server gateway-backup:8000 backup;
