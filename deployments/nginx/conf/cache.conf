# Caching configuration for isA_Cloud
# Defines cache paths and settings

# Cache paths
proxy_cache_path /var/cache/nginx/api
    levels=1:2
    keys_zone=api_cache:50m
    max_size=1g
    inactive=60m
    use_temp_path=off;

proxy_cache_path /var/cache/nginx/static
    levels=1:2
    keys_zone=static_cache:100m
    max_size=5g
    inactive=7d
    use_temp_path=off;

# Cache key configuration
# Include method, host, uri, and some headers
proxy_cache_key "$scheme$request_method$host$request_uri$http_authorization";

# Default cache settings
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;
proxy_cache_valid 500 502 503 504 0s;

# Cache bypass conditions
# Don't cache requests with these headers
map $http_cache_control $no_cache {
    default 0;
    "~*no-cache" 1;
    "~*no-store" 1;
}

# Cache bypass for authenticated requests (can be overridden per location)
map $http_authorization $bypass_auth {
    default 1;
    "" 0;
}

# Cache methods
# Only cache GET and HEAD requests
map $request_method $cacheable_method {
    default 0;
    GET 1;
    HEAD 1;
}

# Ignore certain headers when caching
proxy_ignore_headers Set-Cookie;
proxy_hide_header Set-Cookie;
proxy_hide_header X-Powered-By;

# Add cache status to response headers (for debugging)
add_header X-Cache-Status $upstream_cache_status always;
