# IsA Cloud Gateway Staging Configuration

app:
  name: "IsA Cloud Gateway Staging"
  version: "1.0.0"

environment: "staging"
debug: true

server:
  host: "0.0.0.0"
  http_port: 8000
  grpc_port: 8001

# Staging service configuration - using Consul discovery
services:
  agent_service:
    consul_service_name: "agent_service"
    http_port: 8080
    grpc_port: 9080
    timeout: "60s"
    retry:
      max_attempts: 2
      backoff: "2s"

  model_service:
    consul_service_name: "model_service"
    http_port: 8082
    grpc_port: 9082
    timeout: "120s"
    retry:
      max_attempts: 2
      backoff: "5s"

  mcp_service:
    consul_service_name: "mcp_service"
    http_port: 8081
    grpc_port: 9081
    timeout: "30s"
    retry:
      max_attempts: 3
      backoff: "1s"

  product_service:
    consul_service_name: "product_service"
    http_port: 8215
    timeout: "30s"
    retry:
      max_attempts: 3
      backoff: "1s"

database:
  # Using Supabase Cloud for staging
  host: "db.ugloxikfljpuvakwiadf.supabase.co"
  port: 5432
  database: "postgres"
  username: "postgres"
  password: "0npfjCaFaXXnm289"
  ssl_mode: "require"

redis:
  host: "staging-redis"
  port: 6379
  password: ""
  database: 0

logging:
  level: "info"
  format: "json"
  output: "stdout"

monitoring:
  enabled: true
  port: 9090
  path: "/metrics"
  namespace: "isa_cloud_staging"
  subsystem: "gateway"

security:
  cors:
    enabled: true
    allow_origins:
      - "*"
      # Allow all localhost origins regardless of port for development
      - "http://localhost"
      - "http://localhost:*"
      - "http://127.0.0.1"
      - "http://127.0.0.1:*"
    allow_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
      - "PATCH"
    allow_headers:
      - "Authorization"
      - "Content-Type"
      - "X-Request-ID"
      - "Cache-Control"
      - "X-Requested-With"
      - "Accept"
      - "Origin"
    allow_credentials: true
    expose_headers:
      - "X-Request-ID"
      - "X-Response-Time"

  rate_limit:
    enabled: true                         # ✅ ENABLED - Per-user rate limiting
    type: "per_user"                      # per_user, per_ip, or tiered
    rps: 10                               # Requests per second (per user)
    burst: 20                             # Burst capacity
    # Tiered rate limiting (optional)
    tier_limits:
      free: 10                            # Free tier: 10 RPS
      pro: 50                             # Pro tier: 50 RPS
      enterprise: 200                     # Enterprise tier: 200 RPS

  jwt:
    secret: "staging-secret-key"
    expiration: "24h"
    issuer: "isa-cloud-gateway-staging"

  # Authentication Service Configuration
  auth:
    service_url: "http://localhost:8202"  # Fallback URL
    consul_service: "auth_service"        # Consul service name
    timeout: "5s"
    use_consul: true                      # Use Consul for service discovery
    cache:
      enabled: true                       # ✅ ENABLED - Cache tokens
      ttl: "300s"                         # 5 minutes
      backend: "memory"
    circuit_breaker:
      enabled: true                       # ✅ ENABLED - Protect against cascade failures
      threshold: 5                        # Open after 5 failures
      timeout: "10s"                      # Try again after 10s
    fail_policy: "fail_open"              # For staging - allow on failure

  # Authorization Service Configuration
  authorization:
    service_url: "http://localhost:8203"  # Fallback URL
    consul_service: "authorization_service"
    timeout: "3s"
    use_consul: true
    cache:
      enabled: true                       # ✅ ENABLED - Cache permissions
      ttl: "60s"                          # 1 minute
      backend: "memory"
    circuit_breaker:
      enabled: true                       # ✅ ENABLED - Protect against cascade failures
      threshold: 5                        # Open after 5 failures
      timeout: "10s"                      # Try again after 10s
    fail_policy: "fail_open"              # For staging - allow on failure

mqtt:
  enabled: true
  broker_url: "tcp://staging-mosquitto:1883"
  client_id: "isa_cloud_gateway_staging"
  username: ""
  password: ""
  keep_alive: "60s"
  ping_timeout: "10s"
  clean_session: true
  auto_reconnect: true
  qos: 1
  topics:
    device_telemetry: "devices/+/telemetry"
    device_status: "devices/+/status"
    device_commands: "devices/+/commands"
    device_commands_response: "devices/+/commands/response"
    device_auth: "devices/+/auth"
    device_registration: "devices/register"
    system_events: "system/events"
    notification_user_receive: "notifications/users/+/receive"
    notification_user_ack: "notifications/users/+/ack"
    notification_broadcast: "notifications/broadcast"
    notification_system: "notifications/system/+"

# Enable Consul for staging environment service discovery
consul:
  enabled: true
  host: "staging-consul"
  port: 8500