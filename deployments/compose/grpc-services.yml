# ============================================
# isA Platform - gRPC Infrastructure Services
# ============================================
# 统一的 gRPC 基础设施服务层
# 
# 文件名: deployments/compose/grpc-services.yml
# 用法: docker-compose -f compose/base.yml -f compose/grpc-services.yml up -d
#
# 架构：
#   Python 服务 → gRPC 服务 → 基础设施容器
#
# gRPC 服务端口:
#   - MinIO:    50051
#   - DuckDB:   50052
#   - MQTT:     50053
#   - Loki:     50054
#   - Redis:    50055
#   - NATS:     50056
#   - Supabase: 50057

services:
  # ============== MinIO gRPC Service ==============
  minio-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.minio-service
    image: isa-minio-service:latest
    container_name: isa-minio-grpc
    hostname: isa-minio-grpc  # 设置容器主机名
    ports:
      - "50051:50051"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-minio-grpc
      # MinIO 连接配置 (使用 ISA_CLOUD_STORAGE 前缀)
      - ISA_CLOUD_STORAGE_MINIO_ENDPOINT=staging-minio:9000
      - ISA_CLOUD_STORAGE_MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - ISA_CLOUD_STORAGE_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - ISA_CLOUD_STORAGE_MINIO_USE_SSL=false
      - ISA_CLOUD_STORAGE_MINIO_REGION=us-east-1

      # Consul 服务发现
      - ISA_CLOUD_STORAGE_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_STORAGE_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - ISA_CLOUD_STORAGE_CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - ISA_CLOUD_STORAGE_MINIO_GRPC_PORT=50051
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50051 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== DuckDB gRPC Service ==============
  duckdb-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.duckdb-service
    image: isa-duckdb-service:latest
    container_name: isa-duckdb-grpc
    hostname: isa-duckdb-grpc  # 设置容器主机名
    ports:
      - "50052:50052"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-duckdb-grpc
      # DuckDB 配置
      - ISA_CLOUD_STORAGE_DUCKDB_DATABASE_PATH=/data/duckdb
      - ISA_CLOUD_STORAGE_DUCKDB_MEMORY_LIMIT=2GB

      # MinIO 集成（用于查询 S3 数据）
      - ISA_CLOUD_STORAGE_MINIO_ENDPOINT=staging-minio:9000
      - ISA_CLOUD_STORAGE_MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - ISA_CLOUD_STORAGE_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - ISA_CLOUD_STORAGE_MINIO_USE_SSL=false

      # Consul 配置
      - ISA_CLOUD_STORAGE_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_STORAGE_CONSUL_HOST=${CONSUL_HOST:-staging-consul}

      # Loki 审计日志
      - LOKI_URL=http://staging-loki:3100
      
      # Consul
      - ISA_CLOUD_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      
      # gRPC 配置
      - GRPC_PORT=50052
      - SERVICE_NAME=duckdb-grpc-service
    volumes:
      - duckdb-data:/data/duckdb
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    restart: unless-stopped

  # ============== MQTT gRPC Service ==============
  mqtt-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.mqtt-service
    image: isa-mqtt-service:latest
    container_name: isa-mqtt-grpc
    hostname: isa-mqtt-grpc  # 设置容器主机名
    ports:
      - "50053:50053"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-mqtt-grpc

      # MQTT 连接配置
      - MQTT_BROKER_URL=tcp://staging-mosquitto:1883
      - MQTT_USERNAME=
      - MQTT_PASSWORD=

      # Loki 审计日志
      - LOKI_URL=http://staging-loki:3100

      # Consul
      - ISA_CLOUD_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - ISA_CLOUD_CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50053
      - SERVICE_NAME=mqtt-grpc-service
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50053 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== Loki gRPC Service ==============
  loki-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.loki-service
    image: isa-loki-service:latest
    container_name: isa-loki-grpc
    hostname: isa-loki-grpc  # 设置容器主机名
    ports:
      - "50054:50054"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-loki-grpc

      # Loki 连接配置 (use ISA_CLOUD prefix for logging config)
      - ISA_CLOUD_LOKI_URL=http://staging-loki:3100
      - ISA_CLOUD_LOKI_TENANT_ID=

      # Consul
      - ISA_CLOUD_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - ISA_CLOUD_CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50054
      - SERVICE_NAME=loki-grpc-service
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50054 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== Redis gRPC Service ==============
  redis-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.redis-service
    image: isa-redis-service:latest
    container_name: isa-redis-grpc
    hostname: isa-redis-grpc  # 设置容器主机名
    ports:
      - "50055:50055"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-redis-grpc

      # Redis 连接配置
      - ISA_CLOUD_REDIS_HOST=staging-redis
      - ISA_CLOUD_REDIS_PORT=6379
      - ISA_CLOUD_REDIS_PASSWORD=staging_redis_2024
      - ISA_CLOUD_REDIS_DATABASE=0

      # Loki 审计日志
      - LOKI_URL=http://staging-loki:3100

      # Consul
      - ISA_CLOUD_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - ISA_CLOUD_CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50055
      - SERVICE_NAME=redis-grpc-service
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50055 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== NATS gRPC Service ==============
  nats-grpc-service:
    build:
      context: ../..
      dockerfile: deployments/dockerfiles/Dockerfile.nats-service
    image: isa-nats-service:latest
    container_name: isa-nats-grpc
    ports:
      - "50056:50056"
    environment:
      # NATS 连接配置 (use ISA_CLOUD prefix for event config)
      - ISA_CLOUD_NATS_URLS=nats://staging-nats:4222
      - ISA_CLOUD_NATS_CLUSTER_ID=isa-cloud-cluster
      - ISA_CLOUD_NATS_USERNAME=
      - ISA_CLOUD_NATS_PASSWORD=
      - ISA_CLOUD_NATS_JETSTREAM_ENABLED=true

      # Redis 配置 (for KV store backend)
      - REDIS_HOST=staging-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=

      # MinIO 配置 (for object store backend)
      - MINIO_ENDPOINT=staging-minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_USE_SSL=false

      # Loki 审计日志
      - LOKI_URL=http://staging-loki:3100

      # Consul 配置
      - ISA_CLOUD_CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - ISA_CLOUD_CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - ISA_CLOUD_CONSUL_PORT=8500

      # gRPC 配置
      - ISA_CLOUD_NATS_GRPC_PORT=50056
      - SERVICE_NAME=nats-grpc-service
      - SERVICE_HOSTNAME=isa-nats-grpc
    networks:
      - staging-network
    # depends_on removed - infrastructure services are external
    restart: unless-stopped

  # ============== PostgreSQL gRPC Service ==============
  postgres-grpc-service:
    image: isa-postgres-service:latest
    container_name: isa-postgres-grpc
    hostname: isa-postgres-grpc
    ports:
      - "50061:50061"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-postgres-grpc

      # PostgreSQL 连接配置
      - POSTGRES_HOST=staging-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=isa_platform
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=staging_postgres_2024
      - POSTGRES_SSL_MODE=disable

      # Consul 配置
      - CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50061
      - SERVICE_NAME=postgres-grpc-service
    networks:
      - staging-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50061 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== Qdrant gRPC Service ==============
  qdrant-grpc-service:
    image: isa-qdrant-service:latest
    container_name: isa-qdrant-grpc
    hostname: isa-qdrant-grpc
    ports:
      - "50062:50062"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-qdrant-grpc

      # Qdrant 连接配置
      - QDRANT_HOST=staging-qdrant
      - QDRANT_HTTP_PORT=6333
      - QDRANT_GRPC_PORT=6334
      - QDRANT_API_KEY=
      - QDRANT_USE_HTTPS=false
      - QDRANT_PREFER_GRPC=true

      # Consul 配置
      - CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50062
      - SERVICE_NAME=qdrant-grpc-service
    networks:
      - staging-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50062 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============== Neo4j gRPC Service ==============
  neo4j-grpc-service:
    image: isa-neo4j-service:latest
    container_name: isa-neo4j-grpc
    hostname: isa-neo4j-grpc
    ports:
      - "50063:50063"
    environment:
      # 服务发现配置 (用于 Consul 注册)
      - SERVICE_HOSTNAME=isa-neo4j-grpc

      # Neo4j 连接配置
      - NEO4J_URI=bolt://staging-neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=staging_neo4j_2024
      - NEO4J_DATABASE=neo4j
      - NEO4J_MAX_CONNECTION_POOL_SIZE=50

      # Consul 配置
      - CONSUL_ENABLED=${CONSUL_ENABLED:-true}
      - CONSUL_HOST=${CONSUL_HOST:-staging-consul}
      - CONSUL_PORT=${CONSUL_PORT:-8500}

      # gRPC 配置
      - GRPC_PORT=50063
      - SERVICE_NAME=neo4j-grpc-service
    networks:
      - staging-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50063 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

# Volumes
volumes:
  duckdb-data:

# Networks
networks:
  staging-network:
    name: staging_staging-network
    external: true




