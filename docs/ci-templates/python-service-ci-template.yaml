# CI Template for Python Services
#
# è¿™ä¸ªæ–‡ä»¶æ˜¯æ¨¡æ¿ï¼Œéœ€è¦å¤åˆ¶åˆ°å¯¹åº”çš„ä»“åº“ï¼š
# - isA_Agent/.github/workflows/ci.yaml
# - isA_MCP/.github/workflows/ci.yaml
# - isA_Model/.github/workflows/ci.yaml
# - isA_user/.github/workflows/ci.yaml
#
# ä½¿ç”¨æ—¶éœ€è¦ä¿®æ”¹ï¼š
# 1. SERVICE_NAME: æ”¹ä¸ºå¯¹åº”çš„æœåŠ¡å (agent, mcp, model, user)
# 2. PYTHON_VERSION: æ ¹æ®éœ€è¦è°ƒæ•´ Python ç‰ˆæœ¬
# 3. æµ‹è¯•å‘½ä»¤: æ ¹æ®é¡¹ç›®ç»“æž„è°ƒæ•´

name: CI - Build and Push Service

on:
  push:
    branches: [main, develop, 'release/*']
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/ci.yaml'
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  # âš ï¸ ä¿®æ”¹è¿™é‡Œï¼šæ”¹ä¸ºä½ çš„æœåŠ¡å (agent, mcp, model, user)
  SERVICE_NAME: agent
  # âš ï¸ ä¿®æ”¹è¿™é‡Œï¼šæ”¹ä¸ºä½ çš„ ECR ä»“åº“å
  ECR_REPOSITORY: isa-agent
  # âš ï¸ ä¿®æ”¹è¿™é‡Œï¼šæ”¹ä¸ºä½ çš„ GitOps ä»“åº“
  GITOPS_REPO: your-org/isA_Cloud
  PYTHON_VERSION: '3.11'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Lint å’Œæµ‹è¯•
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black isort mypy

      - name: Format check with black
        run: black --check --diff .
        continue-on-error: true

      - name: Import sorting check with isort
        run: isort --check-only --diff .
        continue-on-error: true

      - name: Lint with flake8
        run: |
          # åœæ­¢æž„å»ºå¦‚æžœæœ‰ Python è¯­æ³•é”™è¯¯æˆ–æœªå®šä¹‰çš„åç§°
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # é€€å‡ºç ä¸º 0ï¼Œå°†æ‰€æœ‰é”™è¯¯è§†ä¸ºè­¦å‘Š
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Type checking with mypy
        run: mypy . --ignore-missing-imports
        continue-on-error: true

      - name: Run tests with pytest
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
        continue-on-error: false

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: ${{ env.SERVICE_NAME }}-coverage

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    needs: lint-and-test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        run: |
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"

          # ç”Ÿæˆæ ‡ç­¾
          TAGS="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          TAGS="${TAGS},${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest"
          TAGS="${TAGS},${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.ref_name }}"

          # å¦‚æžœæ˜¯ tagï¼Œæ·»åŠ ç‰ˆæœ¬å·
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            TAGS="${TAGS},${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "image=${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=${{ env.SERVICE_NAME }}
          cache-to: type=gha,mode=max,scope=${{ env.SERVICE_NAME }}
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Create image summary
        run: |
          echo "### âœ… Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: \`${{ env.SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ steps.meta.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # è§¦å‘ GitOps ä»“åº“æ›´æ–°
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  trigger-gitops:
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger GitOps repository update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITOPS_PAT }}
          repository: ${{ env.GITOPS_REPO }}
          event-type: update-${{ env.SERVICE_NAME }}-image
          client-payload: |
            {
              "service": "${{ env.SERVICE_NAME }}",
              "image": "${{ needs.build-and-push.outputs.image }}",
              "sha": "${{ github.sha }}",
              "ref": "${{ github.ref_name }}",
              "actor": "${{ github.actor }}",
              "repo": "${{ github.repository }}"
            }

      - name: Create GitOps trigger summary
        run: |
          echo "### ðŸ”” GitOps Update Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Sent update notification to \`${{ env.GITOPS_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically deploy this change to EKS cluster." >> $GITHUB_STEP_SUMMARY
